
# Original Data

Load in the dataset. Create the abbreviations for the teams based on the 538 abbreviations.

```{r}
library(tidyverse)
gameData <- read_csv("data/scoresFull.csv")

homeAbb <- sapply(gameData$homeTeam, switch, 
                  "Arizona Cardinals" = "ari", 
                  "Atlanta Falcons" = "atl",
                  "Baltimore Ravens" = "bal",
                  "Buffalo Bills" = "buf",
                  "Carolina Panthers" = "car", 
                  "Chicago Bears" = "chi",
                  "Cincinnati Bengals" = "cin",
                  "Cleveland Browns" = "cle",
                  "Dallas Cowboys" = "dal",
                  "Denver Broncos" = "den",
                  "Detroit Lions" = "det",
                  "Green Bay Packers" = "gb",
                  "Houston Texans" = "hou",
                  "Indianapolis Colts" = "ind",
                  "Jacksonville Jaguars" = "jax",
                  "Kansas City Chiefs" = "kc",
                  "San Diego Chargers" = "lac",
                  "St. Louis Rams" = "lar",
                  "Miami Dolphins" = "mia",
                  "Minnesota Vikings" = "min",
                  "New England Patriots" = "ne",
                  "New Orleans Saints" = "no",
                  "New York Giants" = "nyg",
                  "New York Jets" = "nyj",
                  "Oakland Raiders" = "oak",
                  "Philadelphia Eagles" = "phi",
                  "Pittsburgh Steelers" = "pit",
                  "Seattle Seahawks" = "sea",
                  "San Francisco 49ers" = "sf",
                  "Tampa Bay Buccaneers" = "tb",
                  "Tennessee Titans" = "ten",
                  "Washington Redskins" = "wsh")

awayAbb <- sapply(gameData$awayTeam, switch,
                  "Arizona Cardinals" = "ari", 
                  "Atlanta Falcons" = "atl",
                  "Baltimore Ravens" = "bal",
                  "Buffalo Bills" = "buf",
                  "Carolina Panthers" = "car", 
                  "Chicago Bears" = "chi",
                  "Cincinnati Bengals" = "cin",
                  "Cleveland Browns" = "cle",
                  "Dallas Cowboys" = "dal",
                  "Denver Broncos" = "den",
                  "Detroit Lions" = "det",
                  "Green Bay Packers" = "gb",
                  "Houston Texans" = "hou",
                  "Indianapolis Colts" = "ind",
                  "Jacksonville Jaguars" = "jax",
                  "Kansas City Chiefs" = "kc",
                  "San Diego Chargers" = "lac",
                  "St. Louis Rams" = "lar",
                  "Miami Dolphins" = "mia",
                  "Minnesota Vikings" = "min",
                  "New England Patriots" = "ne",
                  "New Orleans Saints" = "no",
                  "New York Giants" = "nyg",
                  "New York Jets" = "nyj",
                  "Oakland Raiders" = "oak",
                  "Philadelphia Eagles" = "phi",
                  "Pittsburgh Steelers" = "pit",
                  "Seattle Seahawks" = "sea",
                  "San Francisco 49ers" = "sf",
                  "Tampa Bay Buccaneers" = "tb",
                  "Tennessee Titans" = "ten",
                  "Washington Redskins" = "wsh")

gameData$homeAbb <- homeAbb
gameData$awayAbb <- awayAbb


gameData <- gameData %>% 
  mutate(homeWin = ifelse(HFinal - AFinal > 0, 1, 0)) %>%
  select(!c("date", "day"))

```

# NFL Elo

Elo data from 538 for each game 

```{r}
library("jsonlite")

json_file <- 'https://datahub.io/five-thirty-eight/nfl-elo/datapackage.json'
json_data <- fromJSON(paste(readLines(json_file), collapse=""))

# get list of all resources:
# print(json_data$resources$name)

# print all tabular data(if exists any)
for(i in 1:length(json_data$resources$datahub$type)){
  if(json_data$resources$datahub$type[i]=='derived/csv'){
    path_to_file = json_data$resources$path[i]
    eloData <- read.csv(url(path_to_file))
  }
}

# team1 = home, team2 = away
eloData <- eloData %>% 
  filter(season %in% (2002:2014)) %>% 
  select(season, team1, team2, elo1_pre, elo2_pre, score1, score2, date) %>%
  rename("homeAbb" = team1,
         "awayAbb" = team2,
         "homeElo" = elo1_pre,
         "awayElo" = elo2_pre,
         "HFinal" = score1,
         "AFinal" = score2)
```

Remove unnecessary columns for the gameData dataset and merge the 538 elo data onto the dataset. Change the postseason weeks into numeric weeks following the regular season.

```{r}
gameData <- gameData %>%
  select(!c("AQ1", "AQ2", "AQ3", "AQ4", "AOT", "AOT2", 
            "HQ1", "HQ2", "HQ3", "HQ4", "HOT", "HOT2", "stadium", "startTime", 
            "toss", "roof", "surface", "duration", "attendance", "weather", 
            "vegasLine", "OU", "OUvalue", "OUresult", "homeSpread", "HminusAScore")) %>% 
  mutate(week = ifelse(week == "WildCard", 18,
                       ifelse(week == "Division", 19,
                              ifelse(week == "ConfChamp", 20,
                                     ifelse(week == "SuperBowl", 21, week)))),
         awayTOP = as.numeric(awayTOP),
         homeTOP = as.numeric(homeTOP),
         week = as.numeric(week))

gameData <- merge(gameData, eloData, by = c("season", "homeAbb", "awayAbb", "HFinal", "AFinal"))

```

# Prediction Data

Get the schedule of games in the dataset

```{r}
schedule <- gameData %>%
  select("season", "week", "date", "homeTeam", "homeAbb", "awayTeam", "awayAbb", "homeWin")  %>%
  arrange("season", "week")

```

Get the offensive and defensive stats for each team and split them up into two datasets, one for the home team and one for the away team.

```{r}
home <- gameData %>%
  select("season", "week", starts_with("home"), starts_with("H"), starts_with("away"), starts_with("A"), -c(AFinal, HFinal, homeWin, awayTeam, awayAbb, awayElo, awayTOP, awayPenYds, awayNumPen, ATotalPlays)) %>%
  rename("team" = "homeTeam") %>%
  rename_at(vars(starts_with("home")), funs(paste0("off", substring(., 5)))) %>%
  rename_at(vars(starts_with("H")), funs(paste0("off", substring(., 2)))) %>%
  rename_at(vars(starts_with("away")), funs(paste0("def", substring(., 5)))) %>%
  rename_at(vars(starts_with("A")), funs(paste0("def", substring(., 2)))) %>%
  rename("abb" = "offAbb")

away <- gameData %>%
  select("season", "week", starts_with("home"), starts_with("H"), starts_with("away"), starts_with("A"), -c(AFinal, HFinal, homeWin, homeTeam, homeAbb, homeElo, homeTOP, homePenYds, homeNumPen, HTotalPlays)) %>%
  rename("team" = "awayTeam") %>%
  rename_at(vars(starts_with("away")), funs(paste0("off", substring(., 5)))) %>%
  rename_at(vars(starts_with("A")), funs(paste0("off", substring(., 2)))) %>%
  rename_at(vars(starts_with("home")), funs(paste0("def", substring(., 5)))) %>%
  rename_at(vars(starts_with("H")), funs(paste0("def", substring(., 2)))) %>%
  rename("abb" = "offAbb")

```

Combine the home and away datasets onto the schedule. This will get used to average throughout a season in the siny app to get average stats for a matchup based on how each team is doing.

```{r}
# get the stats of the away team
allData <- left_join(schedule, away, by = c("season" = "season", "week" = "week", "awayAbb" = "abb", "awayTeam" = "team"))

# label the stats as Away
colnames(allData)[9:53] <- paste0(colnames(allData)[9:53], "Away")

# get the stats for the home team
allData <- left_join(allData, home, by = c("season" = "season", "week" = "week", "homeAbb" = "abb", "homeTeam" = "team"))

# label the stats as Home
colnames(allData)[54:98] <- paste0(colnames(allData)[54:98], "Home")
```

Save this dataset into a csv.

```{r}
write_csv(allData, "data/allData.csv")
```


Keep for now as a reference for what needs to happen in the aggregation of stats within shiny.

```{r}
# nflData <- merge(data, avgData, by = c("team", "week", "season", "teamRow", "win"))
# 
# nflData <- nflData %>%
#   mutate(offFirstDowns = ifelse(teamRow == 1, offFirstDowns, 
#                                 ifelse(week == 1, lag(avgoffFirstDowns, 1),
#                                        avgoffFirstDowns)),
#          offNetPassYds = ifelse(teamRow == 1, offNetPassYds, 
#                                 ifelse(week == 1, lag(avgoffNetPassYds, 1),
#                                        avgoffNetPassYds)),
#          offTotalYds = ifelse(teamRow == 1, offTotalYds, 
#                                 ifelse(week == 1, lag(avgoffTotalYds, 1),
#                                        avgoffTotalYds)),
#          offTurnovers = ifelse(teamRow == 1, offTurnovers, 
#                                 ifelse(week == 1, lag(avgoffTurnovers, 1),
#                                        avgoffTurnovers)),
#          offTotalPlays = ifelse(teamRow == 1, offTotalPlays, 
#                                 ifelse(week == 1, lag(avgoffTotalPlays, 1),
#                                        avgoffTotalPlays)),
#          offRushYds = ifelse(teamRow == 1, offRushYds, 
#                                 ifelse(week == 1, lag(avgoffRushYds, 1),
#                                        avgoffRushYds)),
#          offRushTD = ifelse(teamRow == 1, offRushTD, 
#                                 ifelse(week == 1, lag(avgoffRushTD, 1),
#                                        avgoffRushTD)),
#          offPassComp = ifelse(teamRow == 1, offPassComp, 
#                                 ifelse(week == 1, lag(avgoffPassComp, 1),
#                                        avgoffPassComp)),
#          offPassAtt = ifelse(teamRow == 1, offPassAtt, 
#                                 ifelse(week == 1, lag(avgoffPassAtt, 1),
#                                        avgoffPassAtt)),
#          offPassYds = ifelse(teamRow == 1, offPassYds, 
#                                 ifelse(week == 1, lag(avgoffPassYds, 1),
#                                        avgoffPassYds)),
#          offPassTD = ifelse(teamRow == 1, offPassTD, 
#                                 ifelse(week == 1, lag(avgoffPassTD, 1),
#                                        avgoffPassTD)),
#          offPassInt = ifelse(teamRow == 1, offPassInt, 
#                                 ifelse(week == 1, lag(avgoffPassInt, 1),
#                                        avgoffPassInt)),
#          offTimesSacked = ifelse(teamRow == 1, offTimesSacked, 
#                                 ifelse(week == 1, lag(avgoffTimesSacked, 1),
#                                        avgoffTimesSacked)),
#          offSackYdsLost = ifelse(teamRow == 1, offSackYdsLost, 
#                                 ifelse(week == 1, lag(avgoffSackYdsLost, 1),
#                                        avgoffSackYdsLost)),
#          offFum = ifelse(teamRow == 1, offFum, 
#                                 ifelse(week == 1, lag(avgoffFum, 1),
#                                        avgoffFum)),
#          offFumLost = ifelse(teamRow == 1, offFumLost, 
#                                 ifelse(week == 1, lag(avgoffFumLost, 1),
#                                        avgoffFumLost)),
#          offNumPen = ifelse(teamRow == 1, offNumPen, 
#                                 ifelse(week == 1, lag(avgoffNumPen, 1),
#                                        avgoffNumPen)),
#          offPenYds = ifelse(teamRow == 1, offPenYds, 
#                                 ifelse(week == 1, lag(avgoffPenYds, 1),
#                                        avgoffPenYds)),
#          off3rdConv = ifelse(teamRow == 1, off3rdConv, 
#                                 ifelse(week == 1, lag(avgoff3rdConv, 1),
#                                        avgoff3rdConv)),
#          off3rdAtt = ifelse(teamRow == 1, off3rdAtt, 
#                                 ifelse(week == 1, lag(avgoff3rdAtt, 1),
#                                        avgoff3rdAtt)),
#          off4thConv = ifelse(teamRow == 1, off4thConv, 
#                                 ifelse(week == 1, lag(avgoff4thConv, 1),
#                                        avgoff4thConv)),
#          off4thAtt = ifelse(teamRow == 1, off4thAtt, 
#                                 ifelse(week == 1, lag(avgoff4thAtt, 1),
#                                        avgoff4thAtt)),
#          top = ifelse(teamRow == 1, top, 
#                                 ifelse(week == 1, lag(avgTOP, 1),
#                                        avgTOP)),
#          defFirstDowns = ifelse(teamRow == 1, defFirstDowns, 
#                                 ifelse(week == 1, lag(avgdefFirstDowns, 1),
#                                        avgdefFirstDowns)),
#          defNetPassYds = ifelse(teamRow == 1, defNetPassYds, 
#                                 ifelse(week == 1, lag(avgdefNetPassYds, 1),
#                                        avgdefNetPassYds)),
#          defTotalYds = ifelse(teamRow == 1, defTotalYds, 
#                                 ifelse(week == 1, lag(avgdefTotalYds, 1),
#                                        avgdefTotalYds)),
#          defTurnovers = ifelse(teamRow == 1, defTurnovers, 
#                                 ifelse(week == 1, lag(avgdefTurnovers, 1),
#                                        avgdefTurnovers)),
#          defTotalPlays = ifelse(teamRow == 1, defTotalPlays, 
#                                 ifelse(week == 1, lag(avgdefTotalPlays, 1),
#                                        avgdefTotalPlays)),
#          defRushYds = ifelse(teamRow == 1, defRushYds, 
#                                 ifelse(week == 1, lag(avgdefRushYds, 1),
#                                        avgdefRushYds)),
#          defRushTD = ifelse(teamRow == 1, defRushTD, 
#                                 ifelse(week == 1, lag(avgdefRushTD, 1),
#                                        avgdefRushTD)),
#          defPassComp = ifelse(teamRow == 1, defPassComp, 
#                                 ifelse(week == 1, lag(avgdefPassComp, 1),
#                                        avgdefPassComp)),
#          defPassAtt = ifelse(teamRow == 1, defPassAtt, 
#                                 ifelse(week == 1, lag(avgdefPassAtt, 1),
#                                        avgdefPassAtt)),
#          defPassYds = ifelse(teamRow == 1, defPassYds, 
#                                 ifelse(week == 1, lag(avgdefPassYds, 1),
#                                        avgdefPassYds)),
#          defPassTD = ifelse(teamRow == 1, defPassTD, 
#                                 ifelse(week == 1, lag(avgdefPassTD, 1),
#                                        avgdefPassTD)),
#          defPassInt = ifelse(teamRow == 1, defPassInt, 
#                                 ifelse(week == 1, lag(avgdefPassInt, 1),
#                                        avgdefPassInt)),
#          defTimesSacked = ifelse(teamRow == 1, defTimesSacked, 
#                                 ifelse(week == 1, lag(avgdefTimesSacked, 1),
#                                        avgdefTimesSacked)),
#          defSackYdsLost = ifelse(teamRow == 1, defSackYdsLost, 
#                                 ifelse(week == 1, lag(avgdefSackYdsLost, 1),
#                                        avgdefSackYdsLost)),
#          defFum = ifelse(teamRow == 1, defFum, 
#                                 ifelse(week == 1, lag(avgdefFum, 1),
#                                        avgdefFum)),
#          defFumLost = ifelse(teamRow == 1, defFumLost, 
#                                 ifelse(week == 1, lag(avgdefFumLost, 1),
#                                        avgdefFumLost)),
#          defNumPen = ifelse(teamRow == 1, defNumPen, 
#                                 ifelse(week == 1, lag(avgdefNumPen, 1),
#                                        avgdefNumPen)),
#          defPenYds = ifelse(teamRow == 1, defPenYds, 
#                                 ifelse(week == 1, lag(avgdefPenYds, 1),
#                                        avgdefPenYds)),
#          def3rdConv = ifelse(teamRow == 1, def3rdConv, 
#                                 ifelse(week == 1, lag(avgdef3rdConv, 1),
#                                        avgdef3rdConv)),
#          def3rdAtt = ifelse(teamRow == 1, def3rdAtt, 
#                                 ifelse(week == 1, lag(avgdef3rdAtt, 1),
#                                        avgdef3rdAtt)),
#          def4thConv = ifelse(teamRow == 1, def4thConv, 
#                                 ifelse(week == 1, lag(avgdef4thConv, 1),
#                                        avgdef4thConv)),
#          def4thAtt = ifelse(teamRow == 1, def4thAtt, 
#                                 ifelse(week == 1, lag(avgdef4thAtt, 1),
#                                        avgdef4thAtt))
#          ) %>%
#   select(-starts_with("avg"))
```

# Visual Data

Take the difference of home stats - away stats for a game

```{r}
visData <- gameData %>%
  mutate(firstDownDiff = HFirstDowns - AFirstDowns,
         netPassYdsDiff = HNetPassYds - ANetPassYds,
         totalYdsDiff = HTotalYds - ATotalYds,
         turnoverDiff = HTurnovers - ATurnovers,
         totalPlaysDiff = HTotalPlays - ATotalPlays,
         rushAttDiff = homeRushAtt - awayRushAtt,
         rushYdsDiff = homeRushYds - awayRushYds,
         rushTDDiff = homeRushTD - awayRushTD,
         passCompDiff = homePassComp - awayPassComp,
         passAttDiff = homePassAtt - awayPassAtt,
         passYdsDiff = homePassYds - awayPassYds,
         passTDDiff = homePassTD - awayPassTD,
         passIntDiff  = homePassInt - awayPassInt,
         timesSackedDiff = homeTimesSacked - awayTimesSacked,
         sackYdsLostDiff = homeSackYdsLost - awaySackYdsLost,
         fumDiff = homeFum - awayFum,
         fumLostDiff = homeFumLost - awayFumLost,
         numPenDiff = homeNumPen - awayNumPen,
         penYdsDiff = homePenYds - awayPenYds,
         thirdConvDiff = home3rdConv - away3rdConv,
         thirdAttDiff = home3rdAtt - away3rdAtt,
         thirdPercDiff = (home3rdConv / home3rdAtt) - (away3rdConv / away3rdAtt),
         fourthConvDiff = home4thConv - away4thConv,
         fourthAttDiff = home4thAtt - away4thAtt,
         fourthPercDiff = (home4thConv / home4thAtt) - (away4thConv / away4thAtt),
         topDiff = homeTOP - awayTOP,
         eloDiff = homeElo - awayElo,
         winner = ifelse(homeWin == 1, "Home", "Away")
         ) %>%
  select(-c("homeAbb", "awayAbb", "HFinal", "AFinal", starts_with("H"), starts_with("home"), starts_with("A"), starts_with("home")))

write_csv(visData, "data/visualGameData.csv")
```



# Team Data

Gets offensive and defensive data for each team in each game they play. Will be used in some of the data visualization to give the user a team level versus a game level

```{r}
home <- gameData %>%
  select("season", "week", "date", "homeTeam", homeWin, starts_with("home"), starts_with("H"), starts_with("away"), starts_with("A"), -c(AFinal, HFinal, awayTeam, awayAbb, awayElo, awayTOP, awayPenYds, awayNumPen, ATotalPlays, homeAbb)) %>%
  rename("team" = "homeTeam", "win" = "homeWin") %>%
  rename_at(vars(starts_with("home")), funs(paste0("off", substring(., 5)))) %>%
  rename_at(vars(starts_with("H")), funs(paste0("off", substring(., 2)))) %>%
  rename_at(vars(starts_with("away")), funs(paste0("def", substring(., 5)))) %>%
  rename_at(vars(starts_with("A")), funs(paste0("def", substring(., 2)))) %>%
  rename(elo = "offElo", top = "offTOP")

away <- gameData %>%
  select("season", "week", "date", "awayTeam", homeWin, starts_with("home"), starts_with("H"), starts_with("away"), starts_with("A"), -c(AFinal, HFinal, homeTeam, homeAbb, homeElo, homeTOP, homePenYds, homeNumPen, HTotalPlays, awayAbb)) %>%
  rename("team" = "awayTeam", "win" = "homeWin") %>%
  rename_at(vars(starts_with("away")), funs(paste0("off", substring(., 5)))) %>%
  rename_at(vars(starts_with("A")), funs(paste0("off", substring(., 2)))) %>%
  rename_at(vars(starts_with("home")), funs(paste0("def", substring(., 5)))) %>%
  rename_at(vars(starts_with("H")), funs(paste0("def", substring(., 2)))) %>%
  rename(elo = "offElo", top = "offTOP")

teamData <- rbind(away, home)

teamData <- teamData %>% arrange(season, team)

write_csv(teamData, "data/teamData.csv")
```

